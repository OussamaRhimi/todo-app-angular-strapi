<div class="container">
  <div class="add-card">
    <div class="header-row">
      <div class="title-block">
        <h2 class="page-title">My Tasks</h2>
        <p class="page-subtitle" *ngIf="!loading">
          {{ tasks.length }} total • {{ remainingCount }} active • {{ completedCount }} done
        </p>
      </div>

      <div class="header-actions">
        <button
          mat-stroked-button
          color="primary"
          type="button"
          class="ai-button"
          (click)="generateTodayTasks()"
          [disabled]="loading || aiGenerating"
        >
          <mat-icon *ngIf="!aiGenerating">auto_awesome</mat-icon>
          <mat-spinner *ngIf="aiGenerating" diameter="18"></mat-spinner>
          AI Plan Today
        </button>

        <button mat-stroked-button color="warn" type="button" class="logout-button" (click)="logout()">
          <mat-icon>logout</mat-icon>
          Logout
        </button>
      </div>
    </div>

    <mat-progress-bar
      *ngIf="!loading && tasks.length > 0"
      class="progress"
      mode="determinate"
      [value]="completionPercent"
      aria-label="Task completion"
    ></mat-progress-bar>

    <form (ngSubmit)="addTask()" class="add-form">
      <div class="input-group">
        <mat-form-field appearance="outline" class="title-field">
          <mat-label>Task Title</mat-label>
          <input matInput [(ngModel)]="newTitle" name="newTitle" required placeholder="What needs doing?">
        </mat-form-field>

        <mat-form-field appearance="outline" class="notes-field">
          <mat-label>Notes</mat-label>
          <input matInput [(ngModel)]="newDescription" name="newDescription" placeholder="Details...">
        </mat-form-field>
      </div>
      <button
        mat-flat-button
        color="primary"
        type="submit"
        class="add-button"
        [disabled]="loading || !newTitle.trim()"
      >
        <mat-icon>add</mat-icon> Add New Task
      </button>
    </form>
  </div>

  <mat-card *ngIf="error" class="error-card">
    <mat-card-content>{{ error }}</mat-card-content>
  </mat-card>

  <div *ngIf="loading" class="loading-box">
    <mat-spinner diameter="40"></mat-spinner>
  </div>

  <div *ngIf="!loading">
    <div
      *ngFor="let task of tasks; trackBy: trackById"
      class="task-item"
      [class.completed]="task.completed"
      [class.editing]="editMode[task.id]"
    >
      
      <ng-container *ngIf="!editMode[task.id]">
        <mat-checkbox [checked]="task.completed" (change)="toggleComplete(task)" color="primary"></mat-checkbox>
        
        <div class="content-area">
          <span class="title-text">{{ task.title }}</span>
          <span class="desc-text" *ngIf="getDescriptionText(task.description)">
            {{ getDescriptionText(task.description) }}
          </span>
        </div>

        <div class="actions">
          <button mat-icon-button (click)="startEdit(task)" color="primary" title="Edit Task">
            <mat-icon>edit</mat-icon>
          </button>
          <button mat-icon-button (click)="deleteTask(task)" color="warn" title="Delete Task">
            <mat-icon>delete_outline</mat-icon>
          </button>
        </div>
      </ng-container>

      <div class="edit-mode-container" *ngIf="editMode[task.id]">
        <div class="edit-fields">
          <mat-form-field appearance="outline">
            <mat-label>Title</mat-label>
            <input matInput [(ngModel)]="editTitle[task.id]" [disabled]="loading">
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Notes</mat-label>
            <textarea matInput [(ngModel)]="editDescription[task.id]" rows="2" [disabled]="loading"></textarea>
          </mat-form-field>
        </div>

        <div class="edit-actions">
          <button mat-stroked-button type="button" (click)="cancelEdit(task.id)" [disabled]="loading">
            Cancel
          </button>
          <button
            mat-flat-button
            color="primary"
            type="button"
            (click)="saveEdit(task)"
            [disabled]="loading || !editTitle[task.id]?.trim()"
          >
            <mat-icon>check</mat-icon>
            Save
          </button>
        </div>
      </div>
    </div>

    <div *ngIf="tasks.length === 0" class="empty-state">
      <mat-icon class="empty-icon">task_alt</mat-icon>
      <p>All clear! You don't have any tasks right now.</p>
    </div>
  </div>
</div>
